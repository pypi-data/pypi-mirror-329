<!DOCTYPE html>
<html lang="en">

<head>
    <title>CDC LAVA Portal</title>
    {% include 'common/head_tables.html' %}
    {% include 'common/head.html' %}
    <meta name="csrf-token" content="{{ csrf_token }}">
</head>

<body class="theme-blue">
    <div id="main-container" class="container-fluid">
        {% include 'common/sidebar.html' %}
        <main id="main-area">
            {% include 'common/header.html' %}
            {% include 'queries/queries_list_breadcrumb.html' %}
            {% include 'queries/queries_list_content.html' %}
            <!-- Additional content sections can be added here following the same structure and guidelines -->
        </main>
    </div>
    <!-- Scripts at the end for faster page loading -->
    <script>
        // Additional JavaScript can go here
    </script>
</body>

</html>
{% include 'common/foot.html' %}

<script>

    function goBack() {
        window.history.back();
    }

</script>
<script> var cdc_datatable_20997 = { "columns": [{ "display": "display", "sort": "true" }] };</script>
<script>
    $(document).ready(function () {
        const noEditFields = [
            'database',
            'execute_flag',
            'execute_results_flag',
            'workflow_parameters',
            'data_product_id',
        ];

        const defaultParameters = 
            "lava_database:edav_prd_cdh.cdh_lava_dev"
            + "|target_database:edav_prd_cdh.cdh_premier_lava_dev"
            + "|specific_user_or_role:gp-u-EDAV-CDH-PREMIER-ANALYSTS-AAD"
            + "|admin_user_or_role:gp-u-EDAV-CDH-ADMIN-AAD"
            + "|lava_admin_user_or_role:gp-u-EDAV-CDH-DEV-LAVA-ADMIN-AAD";

        // Initialize DataTable with specific configuration
        const table = $('#excel-table').DataTable({
            "paging": true,
            "ordering": true,
            "info": true,
            "pageLength": 10,
            "drawCallback": function () {
                // Reapply contenteditable after table redraw
                $('#excel-table tbody td').each(function () {
                    if (!noEditFields.includes((this).getAttribute('data-name'))) {
                        $(this).attr('contenteditable', 'true');
                    }
                });
            },
            "scrollX": "90vw",
            "scrollY": "675px",
        });

        $(document).on('keydown', '.only-numbers', function (event) {
            // Allow: backspace, delete, tab, escape, and enter
            if (event.keyCode == 46 || event.keyCode == 8 || event.keyCode == 9 || event.keyCode == 27 || event.keyCode == 13 ||  // Allow: Ctrl+A 
                (event.keyCode == 65 && event.ctrlKey === true) ||
                // Allow: home, end, left, right
                (event.keyCode >= 35 && event.keyCode <= 39)) {
                // let it happen, don't do anything
                return;
            }
            else {
                // Ensure that it is a number and stop the keypress
                if (event.shiftKey || (event.keyCode < 48 || event.keyCode > 57) && (event.keyCode < 96 || event.keyCode > 105)) {
                    event.preventDefault();
                }
            }
        });

        $("[id^='delete_parameter_']").on('click', function () {
            parameterId = $(this).attr('id').replace(/^delete_/, "");
            $(`#${parameterId}`).remove();
        });

        var newParametersCount = 0;

        $("[id^='add_parameter_']").on('click', function () {
            workflowParameterId = $(this).attr('id').replace(/^add_parameter_/, "");
            var parameter_input_group_template = $('#parameter_input_group_template').html();
            var $parameter_input_group = $(parameter_input_group_template);

            $(`#parameter_group_${workflowParameterId}`).append($parameter_input_group);

            $parameter_input_group.attr('id', `parameter_${workflowParameterId}_new${newParametersCount}`);
            $parameter_input_group.find('[data-template="parameter_name"]').attr('id', `parameter_name_${workflowParameterId}_new${newParametersCount}`);
            $parameter_input_group.find('[data-template="parameter_value"]').attr('id', `parameter_value_${workflowParameterId}_new${newParametersCount}`);
            $parameter_input_group.find('[data-template="delete_parameter"]')
                .attr('id', `delete_parameter_${workflowParameterId}_new${newParametersCount}`)
                .on('click', function () {
                    parameterId = $(this).attr('id').replace(/^delete_/, "");
                    $(`#${parameterId}`).remove();
                });

            newParametersCount++;

        });

        // Handle row clicking and highlighting
        $('#excel-table tbody').on('click', 'tr', function () {
            if ($(this).hasClass('selected')) {
                $(this).removeClass('selected highlight');
            } else {
                table.$('tr.selected').removeClass('selected highlight');
                $(this).addClass('selected highlight');
            }

            // Enable/disable buttons based on selection
            const hasSelection = table.$('tr.selected').length > 0;
            $('#copy-row, #delete-row').prop('disabled', !hasSelection);
        });

        // Handle adding a new row
        $('#add-row').on('click', function () {
            const defaultValues = [
                '',
                'edav_prd_cdh.cdh_premier_lava_dev',
                'execute',
                'skip_execute',
                '',
                '',
                '',
                '',
                'To edit parameters, save this table.',
                'databricks_sql',
                window.location.pathname.split('/').pop(),
                '',
                'save',
                '',
            ];
            // Add the row using DataTables API
            const newRow = table.row.add(defaultValues).draw();

            // Make cells editable
            $(newRow.node()).find('td').each(function (index) {
                columnName = getColumnName(index)
                $(this).attr('data-name', columnName);
                if (noEditFields.includes(columnName)) {
                    $(this).attr('contenteditable', 'false');
                }
            });

            // certain fields only accept numbers
            $('[data-name="workflow_batch_group"]').addClass('only-numbers');

            // Select the new row
            table.$('tr.selected').removeClass('selected highlight');
            $(newRow.node()).addClass('selected highlight');
            $('#copy-row, #delete-row').prop('disabled', false);

            // Scroll to the new row
            $('html, body').animate({
                scrollTop: $(newRow.node()).offset().top
            }, 500);
        });

        // Helper function to get column name based on index
        function getColumnName(index) {
            const columnNames = [
                'view_name', 'database', 'execute_flag', 'execute_results_flag', 'export_schema_metrics',
                'workflow_batch_group', 'workflow_description', 'workflow_name', 'workflow_parameters',
                'workflow_type', 'data_product_id', 'row_id_keys', 'save_flag', 'workflow_category'
            ];
            return columnNames[index];
        }

        // Store for copied row data
        let copiedRowData = null;

        // Handle selecting a row
        $('#select-row').on('click', function () {
            const selectedRows = table.rows('.selected').nodes();
            if (selectedRows.length > 0) {
                $('#copy-row, #delete-row').prop('disabled', false);
                alert('Row selected successfully!');
            } else {
                alert('No row selected! Please click on a row first.');
            }
        });

        // Handle copying a row
        $('#copy-row').on('click', function () {
            const selectedRow = table.row('.selected');
            if (selectedRow.any()) {
                // Get the actual DOM row
                const $rowNode = $(selectedRow.node());

                // Create a deep copy of the row data by getting text content
                copiedRowData = Array.from($rowNode.find('td')).map(td => {
                    if ($(td).attr('data-name') === 'workflow_parameters') {
                        return 'To edit parameters, save this table.';
                    } else {
                        return $(td).text();
                    }
                });

                $('#paste-row').prop('disabled', false);
                alert('Row copied successfully!');
            } else {
                alert('No row selected!');
            }
        });

        // Handle pasting a row
        $('#paste-row').on('click', function () {
            if (!copiedRowData) {
                alert('No row copied! Please select and copy a row first.');
                return;
            }

            // Get selected row or add new row if none selected
            let targetRow;
            const selectedRow = table.row('.selected');

            if (selectedRow.any()) {
                // Paste into selected row
                targetRow = selectedRow;
                selectedRow.data(copiedRowData).draw();
            } else {
                // Add new row with copied data
                targetRow = table.row.add(copiedRowData).draw();
            }

            // Set up the cells with proper attributes
            $(targetRow.node()).find('td').each(function (index) {
                columnName = getColumnName(index)
                $(this).attr('data-name', columnName);
                if (!noEditFields.includes(columnName)) {
                    $(this).attr('contenteditable', 'true');
                }
            });

            // Select and scroll to the target row
            table.$('tr.selected').removeClass('selected highlight');
            $(targetRow.node()).addClass('selected highlight');

            $('html, body').animate({
                scrollTop: $(targetRow.node()).offset().top
            }, 500);

            alert("Paste successful! The parameters on the pasted row have been set to defaults.");
        });

        // Handle deleting a row
        $('#delete-row').on('click', function () {
            const selectedRow = table.row('.selected');
            if (selectedRow.any()) {
                if (confirm('Are you sure you want to delete this row?')) {
                    selectedRow.remove().draw();
                    $('#copy-row, #delete-row').prop('disabled', true);
                }
            } else {
                alert('No row selected! Please select a row to delete.');
            }
        });

        // Handle saving changes
        $('#save-changes').on('click', function () {
            const data = [];
            const required = [
                'view_name',
                'database',
                'execute_flag',
                'execute_results_flag',
                'workflow_batch_group',
                'workflow_name',
                'workflow_parameters',
                'data_product_id',
                'save_flag',
            ];

            try {
                // Iterate through all rows and collect data
                table.rows().every(function () {
                    const $row = $(this.node());
                    const rowId = $(this.node()).attr('id');
                    const rowData = {};

                    $row.find('td').each(function (columnIndex) {
                        const columnName = getColumnName(columnIndex);
                        var input = '';
                        if (columnName === 'workflow_parameters') {
                            // get workflow params
                            if ($(this).text() === 'To edit parameters, save this table.') {
                                input = defaultParameters;
                            } else {
                                $(this).find(`[id^='parameter_${rowId}_']`).each(function () {
                                    input += $(this).find("[id^='parameter_name']").val().trim() + ":" + $(this).find("[id^='parameter_value']").val().trim() + "|";
                                });
                                input = input.slice(0, -1);
                            }
                        } else {
                            input = $(this).text().trim();
                        }
                        if (required.includes(columnName) && input === '') {
                            $(this).addClass('table-danger');
                            throw new ValidationError(columnName);
                        }
                        rowData[columnName] = input;
                    });

                    data.push(rowData);
                });
            }
            catch (error) {
                console.error(error);
                return;
            }

            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
            url = document.location.href

            // Send data to the backend
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ data: data })
            })
                .then(response => {
                    if (!response.ok) {
                        // Parse the JSON error message if the response status is not OK (400, 500, etc.)
                        return response.json().then(errorData => {
                            const errorMessage = formatErrorMessage(errorData);
                            // Throw error with formatted message
                            throw new Error(errorMessage);
                        });
                    }
                    return response.json();
                })
                .then(result => {
                    alert('Changes saved successfully!');
                    location.reload();
                })
                .catch(error => {
                    console.error('Error saving changes:', error);
                    // Display the error message from the server
                    alert(`Failed to save changes. Error: ${error.message}`);
                });
        });

        // Helper function to format the error message
        function formatErrorMessage(errorData) {
            let message = errorData.message || "Unknown error occurred.";
            if (errorData.errors) {
                message += "\nValidation Errors:";
                for (const [field, error] of Object.entries(errorData.errors)) {
                    message += `\n- ${field}: ${error}`;
                }
            }
            return message;
        }

        class ValidationError extends Error {
            constructor(message = "", ...args) {
                super(message, ...args);
                this.message = `Validation failed: the column ${message} is required.`;
                alert(this.message);
            }
        }

    });
</script>

<!-- Add CSS for selected row highlighting -->
<style>
    .selected {
        background-color: #d1ecf1;
        /* Highlight color for selected row */
    }

    .highlight {
        background-color: #f5f5f5;
        /* Highlight color for row when clicked */
    }

    /* Table interaction styles */
    #excel-table tbody tr.highlight {
        background-color: #f5f5f5;
    }

    #excel-table tbody tr.selected {
        background-color: #d1ecf1 !important;
        /* Use !important to override DataTables styling */
    }

    /* Ensure proper spacing between buttons */
    .btn {
        margin-right: 8px;
    }

    /* Improve table cell padding for better editing */
    #excel-table td {
        padding: 8px;
        vertical-align: middle;
    }

    /* Style for editable cells focus state */
    #excel-table td[contenteditable="true"]:focus {
        outline: 2px solid #007bff;
        outline-offset: -2px;
        background-color: #fff;
    }

    /* Delete button styling */
    #delete-row {
        background-color: #dc3545;
        border-color: #dc3545;
        color: white;
    }

    #delete-row:hover {
        background-color: #c82333;
        border-color: #bd2130;
    }

    #delete-row:disabled {
        background-color: #dc354580;
        border-color: #dc354580;
    }
</style>