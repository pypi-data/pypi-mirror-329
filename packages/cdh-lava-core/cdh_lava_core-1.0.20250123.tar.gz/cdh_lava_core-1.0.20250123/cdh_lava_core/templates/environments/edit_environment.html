<!DOCTYPE html>
<html lang="en">

<head>
    <title>Edit Environment</title>
    {% include 'common/head.html' %}
    <meta name="csrf-token" content="{{ csrf_token }}">
</head>

<body class="bg-light">

    <div class="container mt-5">
        <!-- Back button -->
        <a href="javascript:history.back()" class="btn btn-primary mb-4">Back</a>

        <h1 class="mb-4">Edit JSON Configuration</h1>

        <form id="environment-form" method="POST">
            <div class="row g-3">
                {% for key, value in data.items() %}
                <div class="col-md-6">
                    <div class="form-group mb-3 text-left">
                        <label for="{{ key }}" class="form-label">{{ key }}</label>
                        <input type="text" class="form-control" id="{{ key }}" name="{{ key }}" value="{{ value }}">
                    </div>
                </div>
                {% endfor %}
            </div>
            <button type="submit" class="btn btn-primary mt-3">Save</button>
        </form>
    </div>

    <!-- Bootstrap JS and dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</body>

</html>
{% include 'common/foot.html' %}

<script>
    $("#environment-form").submit(function (e) {
        e.preventDefault();

        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

        var body = JSON.stringify(getFormData($("#environment-form")));

        fetch(document.location.href, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: body,
        })
            .then(response => {
                if (!response.ok) {
                    // Parse the JSON error message if the response status is not OK (400, 500, etc.)
                    return response.json().then(errorData => {
                        const errorMessage = formatErrorMessage(errorData);
                        // Throw error with formatted message
                        throw new Error(errorMessage);
                    });
                }
                return response.json();
            })
            .then(result => {
                alert('Changes saved successfully!');
                location.reload()
            })
            .catch(error => {
                console.error('Error saving changes:', error);
                alert('Failed to save changes.');
            });
    });
    
    // Helper function to format the error message
    function formatErrorMessage(errorData) {
        let message = errorData.message || "Unknown error occurred.";
        if (errorData.errors) {
            message += "\nValidation Errors:";
            for (const [field, error] of Object.entries(errorData.errors)) {
                message += `\n- ${field}: ${error}`;
            }
        }
        return message;
    }

    function getFormData($form){
        var unindexed_array = $form.serializeArray();
        var indexed_array = {};

        $.map(unindexed_array, function(n, i){
            indexed_array[n['name']] = n['value'];
        });

        return indexed_array;
    }
    
</script>