include:
  - project: 'cta-computing/dpps/aiv/dpps-aiv-toolkit'
    ref: 70ee653309a742f055c1dfae5c107c2259abca42
    file: "ci-functions.yml"
  - "aiv-config.yml"

variables:
  # make sure we use the images that were just build and pushed
  CHART_EXTRA_VALUES: "--set image.tag=${DOCKER_TAG}"
  # used by jobs in test report
  DPPS_AIV_TOOLKIT_DIR: ./dpps-aiv-toolkit/
  CONDA_IMAGE: "quay.io/condaforge/miniforge3:24.11.3-0"


stages:
  - prepare
  - lint
  - build
  - sign
  - tests
  - sonarqube
  - publish
  - report

build-docs:
  image: "${CONDA_IMAGE}"

  before_script:
    - source /opt/conda/etc/profile.d/conda.sh
    - mamba create -y -n ci python=3.12 gfal2 m2crypto dirac-grid make
    - conda activate ci
    - python --version
    - pip install .[doc]


pylint:
  image: "${CONDA_IMAGE}"

  before_script:
    - apt update && apt install -y --no-install-recommends git
    - source /opt/conda/etc/profile.d/conda.sh
    - mamba create -y -n ci python=3.12 gfal2 m2crypto dirac-grid pylint
    - conda activate ci
    - python --version
    - pip install .[all]


build:
  retry: 2
  variables:
    CI_HARBOR_REGISTRY_IMAGE: harbor.cta-observatory.org/dpps/${CI_PROJECT_NAME}-server:${DOCKER_TAG}
    DOCKER_IMAGE_CONTEXT: docker/server

build-client:
  retry: 2
  extends: build
  variables:
    CI_HARBOR_REGISTRY_IMAGE: harbor.cta-observatory.org/dpps/${CI_PROJECT_NAME}-client:${DOCKER_TAG}
    DOCKER_IMAGE_CONTEXT: docker/client

build-ce:
  retry: 2
  extends: build
  variables:
    CI_HARBOR_REGISTRY_IMAGE: harbor.cta-observatory.org/dpps/${CI_PROJECT_NAME}-ce:${DOCKER_TAG}
    DOCKER_IMAGE_CONTEXT: docker/ce
